<!DOCTYPE html>
<html lang="en" data-color-scheme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Basketball Scoreboard Pro</title>
  
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, collection, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Global variables provided by the Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // Global Firebase instances
    let app, db, auth, userId;
    
    // Game state management
    const appState = {
      view: 'landing',
      isHost: false,
      gameCode: null,
      game: null,
      gameRunning: false,
      shotClockRunning: false,
      selectedPlayer: null,
      actionHistory: [],
      clockEditing: false,
      timers: { masterTimer: null }
    };
    
    // UI shortcuts
    const $ = (id) => document.getElementById(id);
    const $$ = (sel) => document.querySelectorAll(sel);
    
    // Helper functions
    function generateGameCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }
    
    function pad2(n) {
      return n.toString().padStart(2, '0');
    }
    
    function formatTime(m, s) {
      return `${pad2(m)}:${pad2(s)}`;
    }
    
    function toast(message, type = 'info', duration = 2000) {
      const c = $('toastContainer');
      if (!c) return;
      const el = document.createElement('div');
      const size = message.length > 50 || type === 'error' ? 'large' :
                   message.length > 30 || type === 'warning' ? 'medium' : 'small';
      el.className = `toast ${type} ${size}`;
      el.textContent = message;
      c.appendChild(el);
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.transform = 'translateX(100%)';
        setTimeout(() => el.remove(), 300);
      }, duration);
    }
    
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        toast('Game code copied!', 'success', 1500);
      } catch (err) {
        // Fallback for older browsers
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand('copy');
          toast('Game code copied!', 'success', 1500);
        } catch {
          toast('Copy failed - copy manually', 'warning', 3000);
        }
        ta.remove();
      }
    }
    
    // View Management
    function showView(view) {
      const ids = ['landing', 'config', 'setup', 'control', 'viewer'];
      ids.forEach(v => {
        const el = $(`${v}-view`);
        if (el) {
          el.classList.add('hidden');
        }
      });
      const targetEl = $(`${view}-view`);
      if (targetEl) {
        targetEl.classList.remove('hidden');
      }
      appState.view = view;
    }
    
    // Player Stats Initialization
    function createPlayerStats() {
      return {
        points: 0,
        ftm: 0, // Free Throws Made
        fta: 0, // Free Throws Attempted
        fgm: 0, // Field Goals Made (2-pointers)
        fga: 0, // Field Goals Attempted (2-pointers)
        tpm: 0, // 3-Pointers Made
        tpa: 0, // 3-Pointers Attempted
        rebounds: { off: 0, def: 0 },
        assists: 0,
        steals: 0,
        blocks: 0,
        turnovers: 0,
        fouls: 0,
      };
    }
    
    // Player Scoring Logic
    function handlePlayerStatChange(stat, value = 1) {
      if (!appState.game || !appState.selectedPlayer) return;
    
      const game = appState.game;
      const team = game.gameState.teamA.players.find(p => p.id === appState.selectedPlayer) ? 'teamA' : 'teamB';
      const player = game.gameState[team].players.find(p => p.id === appState.selectedPlayer);
      if (!player) return;
    
      switch (stat) {
        case 'ftm':
          player.stats.ftm += value;
          player.stats.fta += value;
          player.stats.points += value;
          break;
        case 'fgm':
          player.stats.fgm += value;
          player.stats.fga += value;
          player.stats.points += value * 2;
          break;
        case 'tpm':
          player.stats.tpm += value;
          player.stats.tpa += value;
          player.stats.points += value * 3;
          break;
        case 'fga': // Missed 2-pointer
          player.stats.fga += value;
          break;
        case 'tpa': // Missed 3-pointer
          player.stats.tpa += value;
          break;
        case 'rebounds_off':
          player.stats.rebounds.off += value;
          break;
        case 'rebounds_def':
          player.stats.rebounds.def += value;
          break;
        case 'assists':
          player.stats.assists += value;
          break;
        case 'steals':
          player.stats.steals += value;
          break;
        case 'blocks':
          player.stats.blocks += value;
          break;
        case 'turnovers':
          player.stats.turnovers += value;
          break;
        case 'fouls':
          player.stats.fouls += value;
          break;
        default:
          break;
      }
    
      saveGameState();
    }
    
    // Toggle game and shot clocks
    function toggleMasterGame() {
      if (!appState.game) return;
      if (appState.gameRunning || appState.shotClockRunning) {
        appState.gameRunning = false;
        appState.shotClockRunning = false;
        stopMasterTimer();
        toast('Game paused', 'info', 1500);
      } else {
        appState.gameRunning = true;
        if (appState.game.settings.shotClockDuration > 0 && appState.game.gameState.shotClock > 0) {
          appState.shotClockRunning = true;
        }
        startMasterTimer();
        toast('Game started!', 'success', 1500);
      }
      updateMasterStartButton();
      saveGameState();
    }
    
    // Update Score Logic
    function updateScore(team, points) {
      if (!appState.game) return;
      const game = appState.game;
      game.gameState[team].score += points;
      saveGameState();
    }
    
    // Game Clock Logic
    function handleShotClockViolation() {
      playViolation();
      toast('SHOT CLOCK VIOLATION!', 'error', 3000);
      
      const g = appState.game;
      if (g) {
        appState.shotClockRunning = false;
        const cur = g.gameState.possession;
        g.gameState.possession = cur === 'teamA' ? 'teamB' : 'teamA';
        g.gameState.shotClock = 0;
        removeShotClockWarning();
        saveGameState();
      }
    }
    
    function startMasterTimer() {
      stopMasterTimer();
      appState.timers.masterTimer = setInterval(() => {
        const g = appState.game;
        if (!g) return;
        
        let changed = false;
        
        // Game clock
        if (appState.gameRunning) {
          const t = g.gameState.gameTime;
          if (t.seconds > 0) {
            t.seconds--; changed = true;
          } else if (t.minutes > 0) {
            t.minutes--; t.seconds = 59; changed = true;
          } else {
            appState.gameRunning = false;
            appState.shotClockRunning = false;
            toast('Period ended!', 'warning', 3000);
            changed = true;
          }
        }
        
        // Shot clock
        if (appState.shotClockRunning && g.settings.shotClockDuration > 0) {
          if (g.gameState.shotClock > 0) {
            g.gameState.shotClock--; changed = true;
            if (g.gameState.shotClock <= 5) addShotClockWarning();
          } else {
            handleShotClockViolation();
            changed = true;
          }
        }
        
        if (changed) {
          saveGameState();
        }
      }, 1000);
    }
    
    function stopMasterTimer() {
      if (appState.timers.masterTimer) {
        clearInterval(appState.timers.masterTimer);
        appState.timers.masterTimer = null;
      }
    }
    
    function playViolation() {
      const buzzer = $('buzzerSound');
      if (buzzer) {
        buzzer.currentTime = 0;
        buzzer.play().catch(()=>{});
      }
      const alert = $('shotClockViolation');
      if (alert) {
        alert.classList.remove('hidden');
        setTimeout(() => alert.classList.add('hidden'), 2000);
      }
    }
    
    // UI Updates
    function addShotClockWarning() {
      $('shotClockDisplay')?.classList.add('warning');
      $('viewerShotClock')?.classList.add('warning');
    }
    
    function removeShotClockWarning() {
      $('shotClockDisplay')?.classList.remove('warning');
      $('viewerShotClock')?.classList.remove('warning');
    }
    
    function updateMasterStartButton() {
      const btn = $('startGameBtn');
      if (!btn) return;
      if (appState.gameRunning || appState.shotClockRunning) {
        btn.textContent = 'PAUSE GAME';
        btn.className = 'btn btn--primary master-start-btn pause';
      } else {
        btn.textContent = 'START GAME';
        btn.className = 'btn btn--primary master-start-btn resume';
      }
    }
    
    function updateControlDisplay() {
      if (!appState.game) return;
      const game = appState.game;
      const gameState = game.gameState;
    
      $('controlGameCode').textContent = game.gameCode;
      $('controlGameName').textContent = game.settings.gameName || 'Basketball Game';
      $('teamANameHdr').textContent = game.settings.teamAName;
      $('teamBNameHdr').textContent = game.settings.teamBName;
      $('teamAScore').textContent = gameState.teamA.score;
      $('teamBScore').textContent = gameState.teamB.score;
      $('periodDisplay').textContent = gameState.period;
      $('clockDisplay').textContent = formatTime(gameState.gameTime.minutes, gameState.gameTime.seconds);
    
      const teamAColor = game.settings.teamAColor;
      const teamBColor = game.settings.teamBColor;
      $('teamANameHdr').style.background = `linear-gradient(to right, ${teamAColor}, transparent)`;
      $('teamBNameHdr').style.background = `linear-gradient(to left, ${teamBColor}, transparent)`;
    
      const teamACol = $('teamACol');
      const teamBCol = $('teamBCol');
      if (gameState.possession === 'teamA') {
          teamACol.style.border = `3px solid ${teamAColor}`;
          teamBCol.style.border = 'none';
      } else if (gameState.possession === 'teamB') {
          teamACol.style.border = 'none';
          teamBCol.style.border = `3px solid ${teamBColor}`;
      } else {
          teamACol.style.border = 'none';
          teamBCol.style.border = 'none';
      }
    
      // Shot clock
      const shotClockSection = $('shotClockSection');
      if (game.settings.shotClockDuration > 0) {
        shotClockSection.classList.remove('hidden');
        $('shotClockDisplay').textContent = gameState.shotClock;
      } else {
        shotClockSection.classList.add('hidden');
      }
      
      updateMasterStartButton();
      updatePlayerStatsUI();
    }
    
    function updateSpectatorView() {
      if (!appState.game) return;
      const game = appState.game;
      const gameState = game.gameState;
    
      $('viewerGameName').textContent = game.settings.gameName || 'Basketball Game';
      $('viewerTeamAName').textContent = game.settings.teamAName;
      $('viewerTeamBName').textContent = game.settings.teamBName;
      $('viewerTeamAScore').textContent = gameState.teamA.score;
      $('viewerTeamBScore').textContent = gameState.teamB.score;
      $('viewerClock').textContent = formatTime(gameState.gameTime.minutes, gameState.gameTime.seconds);
      $('viewerPeriod').textContent = gameState.period;
    
      // Shot clock
      const viewerShotClockEl = $('viewerShotClock');
      if (game.settings.shotClockDuration > 0) {
        viewerShotClockEl.classList.remove('hidden');
        viewerShotClockEl.textContent = gameState.shotClock;
      } else {
        viewerShotClockEl.classList.add('hidden');
      }
      
      const possessionText = `Possession: ${gameState.possession === 'teamA' ? game.settings.teamAName : game.settings.teamBName}`;
      $('viewerPossession').textContent = possessionText;
    
      // Update possession colors
      const viewerTeamA = document.querySelector('.viewer-team:first-of-type');
      const viewerTeamB = document.querySelector('.viewer-team:last-of-type');
      if (gameState.possession === 'teamA') {
          viewerTeamA.style.border = `3px solid ${game.settings.teamAColor}`;
          viewerTeamB.style.border = 'none';
      } else if (gameState.possession === 'teamB') {
          viewerTeamB.style.border = `3px solid ${game.settings.teamBColor}`;
          viewerTeamA.style.border = 'none';
      } else {
          viewerTeamA.style.border = 'none';
          viewerTeamB.style.border = 'none';
      }
    }
    
    function updatePlayerStatsUI() {
        if (appState.game?.settings.gameType !== 'full') {
            $('statsSection').classList.add('hidden');
            return;
        }
    
        $('statsSection').classList.remove('hidden');
        const statTeam = $('statTeamSelect').value;
        const players = appState.game.gameState[statTeam].players;
        const grid = $('playerScoringGrid');
        grid.innerHTML = '';
    
        players.forEach(player => {
            const isSelected = appState.selectedPlayer === player.id;
            const card = document.createElement('div');
            card.className = `player-score-card ${isSelected ? 'selected' : ''}`;
            card.dataset.playerId = player.id;
    
            // Calculate shooting percentages
            const fg_pct = player.stats.fga > 0 ? ((player.stats.fgm / player.stats.fga) * 100).toFixed(1) : 0;
            const tp_pct = player.stats.tpa > 0 ? ((player.stats.tpm / player.stats.tpa) * 100).toFixed(1) : 0;
            const ft_pct = player.stats.fta > 0 ? ((player.stats.ftm / player.stats.fta) * 100).toFixed(1) : 0;
    
            card.innerHTML = `
                <div class="player-info">
                    <span class="player-number">${player.number}</span>
                    <span class="player-name">${player.name}</span>
                </div>
                <div class="player-stats">
                    <strong>PTS: ${player.stats.points}</strong> | FT: ${player.stats.ftm}/${player.stats.fta} (${ft_pct}%) | FG: ${player.stats.fgm}/${player.stats.fga} (${fg_pct}%) | 3PT: ${player.stats.tpm}/${player.stats.tpa} (${tp_pct}%)
                </div>
                <div class="player-scoring-buttons">
                    <button class="btn btn--secondary btn--score-1" data-stat="ftm">FTM</button>
                    <button class="btn btn--secondary btn--score-2" data-stat="fgm">2PM</button>
                    <button class="btn btn--secondary btn--score-3" data-stat="tpm">3PM</button>
                    <button class="btn btn--outline btn--miss-2" data-stat="fga">Miss 2</button>
                    <button class="btn btn--outline btn--miss-3" data-stat="tpa">Miss 3</button>
                </div>
            `;
            grid.appendChild(card);
    
            // Add click listener for selecting player and adding points
            card.addEventListener('click', (e) => {
                // Handle button clicks
                if (e.target.tagName === 'BUTTON') {
                    e.stopPropagation();
                    const stat = e.target.dataset.stat;
                    appState.selectedPlayer = player.id;
                    handlePlayerStatChange(stat);
                    return;
                }
    
                // Handle player card selection
                if (appState.selectedPlayer === player.id) {
                    appState.selectedPlayer = null;
                } else {
                    appState.selectedPlayer = player.id;
                }
                updatePlayerStatsUI();
            });
        });
    }
    
    // Firebase Handlers
    async function setupFirebase() {
        if (!firebaseConfig.apiKey) {
            console.error("Firebase config is missing. App will not function correctly.");
            return;
        }
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Sign in with the provided custom token or anonymously
            if (initialAuthToken) {
              await signInWithCustomToken(auth, initialAuthToken);
            } else {
              await signInAnonymously(auth);
            }

            // Listen for auth state changes
            onAuthStateChanged(auth, (user) => {
              if (user) {
                userId = user.uid;
                toast(`Signed in as user: ${userId.substring(0, 8)}`, 'success');
              } else {
                toast("Signed out", 'warning');
                userId = null;
              }
            });
        } catch (error) {
            console.error("Error setting up Firebase:", error);
            toast("Firebase setup failed", 'error');
        }
    }
    
    async function saveGameState() {
      if (!appState.game || !db) return;
      try {
        const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', appState.gameCode);
        await setDoc(gameRef, { game: appState.game, hostId: userId });
        console.log("Game state saved successfully.");
      } catch (e) {
        console.error("Error saving game state: ", e);
        toast("Failed to save game state.", 'error');
      }
    }
    
    async function createGame(gameConfig) {
      if (!db || !userId) {
        toast('Authentication failed, cannot create game.', 'error');
        return;
      }
      
      appState.gameCode = generateGameCode();
      const newGame = {
        gameCode: appState.gameCode,
        settings: gameConfig,
        gameState: {
          teamA: { score: 0, players: gameConfig.gameType === 'full' ? [] : null },
          teamB: { score: 0, players: gameConfig.gameType === 'full' ? [] : null },
          period: 1,
          gameTime: { minutes: gameConfig.periodDuration, seconds: 0 },
          shotClock: gameConfig.shotClockDuration,
          possession: 'teamA',
          fouls: { teamA: 0, teamB: 0 }
        }
      };
      appState.game = newGame;
      appState.isHost = true;
      
      await saveGameState();
      
      toast(`Game created with code: ${appState.gameCode}`, 'success');
      
      const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', appState.gameCode);
      onSnapshot(gameRef, (doc) => {
        if (doc.exists() && doc.data().game) {
            appState.game = doc.data().game;
            // Update UI based on the new state
            if (appState.view === 'control') {
                updateControlDisplay();
            }
            if (appState.view === 'viewer') {
                updateSpectatorView();
            }
        }
      });
    }
    
    async function joinGame(gameCode) {
        if (!db) return;
        
        const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameCode);
        const gameDoc = await getDoc(gameRef);
        
        if (!gameDoc.exists()) {
            toast('Game code not found.', 'error');
            return;
        }
        
        appState.gameCode = gameCode;
        appState.isHost = false;
        appState.game = gameDoc.data().game;
        showView('viewer');
        
        toast(`Joined game ${gameCode}`, 'success');
        
        // Listen for real-time updates
        onSnapshot(gameRef, (doc) => {
            if (doc.exists() && doc.data().game) {
                appState.game = doc.data().game;
                updateSpectatorView();
            }
        });
    }
    
    // Event Handlers
    function initEventListeners() {
      // Landing page
      $('watchGameBtn').addEventListener('click', () => {
        const gameCode = $('watchCodeInput').value;
        joinGame(gameCode);
      });
      $('watchCodeInput').addEventListener('input', (e) => {
        const code = e.target.value.trim();
        $('watchGameBtn').disabled = code.length !== 6;
      });
      $('createGameBtn').addEventListener('click', () => {
        // Here you would add host password validation
        const password = $('hostPasswordInput').value;
        if (password.length < 4) {
          toast('Password must be at least 4 characters.', 'warning');
          return;
        }
        
        // This is a placeholder for real auth
        // For now, we just proceed
        appState.isHost = true;
        showView('config');
        $('configGameCode').textContent = 'Generating...';
        
        // Generate and display code on config view
        const newCode = generateGameCode();
        appState.gameCode = newCode;
        $('configGameCode').textContent = newCode;
        
      });
      $('quickGameBtn').addEventListener('click', () => {
        const quickGameConfig = {
          gameName: 'Friendly Match',
          periodDuration: 12,
          shotClockDuration: 24,
          teamAName: 'Home',
          teamBName: 'Away',
          teamAColor: '#FF6B35',
          teamBColor: '#1B263B',
          gameType: 'friendly',
        };
        createGame(quickGameConfig).then(() => {
          showView('control');
        });
      });
      
      // Config View
      $('copyConfigCode').addEventListener('click', () => copyToClipboard(appState.gameCode));
      $('backToLandingFromConfig').addEventListener('click', () => showView('landing'));
      $('shotClockSelect').addEventListener('change', (e) => {
        $('customShotClockGroup').classList.toggle('hidden', e.target.value !== 'custom');
      });
      $('proceedToSetup').addEventListener('click', () => {
        const gameConfig = {
          gameName: $('gameNameInput').value || 'Basketball Game',
          periodDuration: parseInt($('periodDurationSelect').value),
          shotClockDuration: $('shotClockSelect').value === 'custom' ? parseInt($('customShotClock').value) : parseInt($('shotClockSelect').value),
          teamAName: $('teamAName').value || 'Team A',
          teamBName: $('teamBName').value || 'Team B',
          teamAColor: $('teamAColor').value,
          teamBColor: $('teamBColor').value,
          gameType: $$('input[name="gameType"]:checked')[0].value,
        };
        createGame(gameConfig).then(() => {
          if (appState.game.settings.gameType === 'full') {
            showView('setup');
            $('setupGameCode').textContent = appState.gameCode;
            $('teamASetupTitle').textContent = appState.game.settings.teamAName;
            $('teamBSetupTitle').textContent = appState.game.settings.teamBName;
          } else {
            showView('control');
          }
        });
      });
      
      // Setup View
      $('copySetupCode').addEventListener('click', () => copyToClipboard(appState.gameCode));
      $('backToConfig').addEventListener('click', () => showView('config'));
      $('skipRosterSetup').addEventListener('click', () => showView('control'));
      $('startGame').addEventListener('click', () => showView('control'));
      
      $('addTeamAPlayer').addEventListener('click', () => addPlayer('teamA'));
      $('addTeamBPlayer').addEventListener('click', () => addPlayer('teamB'));
      
      function addPlayer(team) {
        const numberInput = $(`${team}PlayerNumber`);
        const nameInput = $(`${team}PlayerName`);
        const rosterEl = $(`${team}Roster`);
        const countEl = $(`${team}Count`);
        
        const playerNumber = numberInput.value;
        const playerName = nameInput.value.trim();
        
        if (!playerNumber || !playerName) {
          toast('Please enter both number and name.', 'warning');
          return;
        }
        
        const newPlayer = {
          id: `player-${Date.now()}`,
          number: parseInt(playerNumber),
          name: playerName,
          stats: createPlayerStats()
        };
        
        appState.game.gameState[team].players.push(newPlayer);
        saveGameState();
        
        const playerItem = document.createElement('div');
        playerItem.className = 'roster-item';
        playerItem.innerHTML = `
          <div class="roster-info">
            <span class="roster-number">${newPlayer.number}</span>
            <div class="roster-details">
              <span class="roster-name">${newPlayer.name}</span>
            </div>
          </div>
          <button class="remove-player" data-player-id="${newPlayer.id}">Remove</button>
        `;
        rosterEl.appendChild(playerItem);
        countEl.textContent = appState.game.gameState[team].players.length;
        
        numberInput.value = '';
        nameInput.value = '';
      }
      
      // Add a single listener for both rosters to handle removal
      $$('.roster-list').forEach(list => {
          list.addEventListener('click', (e) => {
              if (e.target.classList.contains('remove-player')) {
                  const playerId = e.target.dataset.playerId;
                  const team = list.id === 'teamARoster' ? 'teamA' : 'teamB';
                  appState.game.gameState[team].players = appState.game.gameState[team].players.filter(p => p.id !== playerId);
                  saveGameState();
                  e.target.closest('.roster-item').remove();
                  $(`${team}Count`).textContent = appState.game.gameState[team].players.length;
              }
          });
      });
      
      // Control View
      $('copyControlCode').addEventListener('click', () => copyToClipboard(appState.gameCode));
      $('goToViewer').addEventListener('click', () => {
          window.open(window.location.href, '_blank');
      });
      $('startGameBtn').addEventListener('click', toggleMasterGame);
      $('resetAllClocksBtn').addEventListener('click', resetAllClocks);
      
      $('teamAPlus1').addEventListener('click', () => updateScore('teamA', 1));
      $('teamAPlus2').addEventListener('click', () => updateScore('teamA', 2));
      $('teamAPlus3').addEventListener('click', () => updateScore('teamA', 3));
      $('teamAMinus1').addEventListener('click', () => updateScore('teamA', -1));
      $('teamBPlus1').addEventListener('click', () => updateScore('teamB', 1));
      $('teamBPlus2').addEventListener('click', () => updateScore('teamB', 2));
      $('teamBPlus3').addEventListener('click', () => updateScore('teamB', 3));
      $('teamBMinus1').addEventListener('click', () => updateScore('teamB', -1));
      
      // Clock and Period controls
      $('editClockBtn').addEventListener('click', () => {
        appState.clockEditing = true;
        $('editMinutes').value = appState.game.gameState.gameTime.minutes;
        $('editSeconds').value = appState.game.gameState.gameTime.seconds;
        $('editClockModal').classList.remove('hidden');
      });
      $('nextPeriodBtn').addEventListener('click', () => {
          if (!appState.game) return;
          appState.game.gameState.period++;
          resetAllClocks();
          saveGameState();
      });
      $('prevPeriodBtn').addEventListener('click', () => {
          if (!appState.game || appState.game.gameState.period <= 1) return;
          appState.game.gameState.period--;
          resetAllClocks();
          saveGameState();
      });
      
      // Shot clock controls
      $('startShotClockBtn').addEventListener('click', () => {
          appState.shotClockRunning = true;
          startMasterTimer();
          saveGameState();
          toast('Shot clock started', 'info');
      });
      $('resetShot14Btn').addEventListener('click', () => {
          if (!appState.game) return;
          appState.game.gameState.shotClock = 14;
          appState.shotClockRunning = true;
          removeShotClockWarning();
          saveGameState();
          toast('Shot clock reset to 14', 'info');
      });
      $('resetShot24Btn').addEventListener('click', () => {
          if (!appState.game) return;
          appState.game.gameState.shotClock = 24;
          appState.shotClockRunning = true;
          removeShotClockWarning();
          saveGameState();
          toast('Shot clock reset to 24', 'info');
      });
      $('editShotClockBtn').addEventListener('click', () => {
        appState.clockEditing = true;
        $('editShotClockSeconds').value = appState.game.gameState.shotClock;
        $('editShotClockModal').classList.remove('hidden');
      });
      
      // Possession controls
      $('possessionTeamA').addEventListener('click', () => {
          if (!appState.game) return;
          appState.game.gameState.possession = 'teamA';
          saveGameState();
      });
      $('possessionTeamB').addEventListener('click', () => {
          if (!appState.game) return;
          appState.game.gameState.possession = 'teamB';
          saveGameState();
      });
      
      // Player Stats controls
      $('statTeamSelect').addEventListener('change', updatePlayerStatsUI);
      
      // Modals
      $('cancelClockEdit').addEventListener('click', () => $('editClockModal').classList.add('hidden'));
      $('saveClockEdit').addEventListener('click', () => {
          if (!appState.game) return;
          const minutes = parseInt($('editMinutes').value);
          const seconds = parseInt($('editSeconds').value);
          
          if (!isNaN(minutes) && !isNaN(seconds)) {
            appState.game.gameState.gameTime.minutes = minutes;
            appState.game.gameState.gameTime.seconds = seconds;
            saveGameState();
            toast('Game clock updated', 'success');
          }
          $('editClockModal').classList.add('hidden');
          appState.clockEditing = false;
      });
      $('cancelShotClockEdit').addEventListener('click', () => $('editShotClockModal').classList.add('hidden'));
      $('saveShotClockEdit').addEventListener('click', () => {
          if (!appState.game) return;
          const seconds = parseInt($('editShotClockSeconds').value);
          if (!isNaN(seconds)) {
            appState.game.gameState.shotClock = seconds;
            saveGameState();
            toast('Shot clock updated', 'success');
          }
          $('editShotClockModal').classList.add('hidden');
          appState.clockEditing = false;
      });

      // Spacebar functionality
      window.addEventListener('keydown', (e) => {
        // Only toggle if the spacebar is pressed and we're not focused on an input field
        if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT' && e.target.tagName !== 'TEXTAREA') {
          e.preventDefault();
          toggleMasterGame();
        }
      });
    }
    
    // Main execution
    window.onload = async () => {
      await setupFirebase();
      initEventListeners();
      // Initially show landing page
      showView('landing');
      console.log('App Initialized');
    };
  </script>
  
  <style>
    /* =======================================================
    INLINE STYLES - BASKETBALL SCOREBOARD PRO
    These styles are a combination of the original `style.css`
    and new additions for improved functionality and aesthetics.
    ======================================================= 
    */
    :root {
      /* Primitive Color Tokens */
      --color-white: #ffffff;
      --color-black: #000000;
      --color-cream-50: #fcfcf9;
      --color-cream-100: #fffefd;
      --color-gray-200: #f5f5f5;
      --color-gray-300: #a7a9a9;
      --color-gray-400: #777c7c;
      --color-slate-500: #626c71;
      --color-brown-600: #5e5240;
      --color-charcoal-700: #1f2121;
      --color-charcoal-800: #262828;
      --color-slate-900: #13343b;
      --color-teal-300: #32b8c6;
      --color-teal-400: #2da6b2;
      --color-teal-500: #21808d;
      --color-teal-600: #1d7480;
      --color-teal-700: #1a6873;
      --color-teal-800: #2996a1;
      --color-red-400: #ff5459;
      --color-red-500: #c0152f;
      --color-orange-400: #e68161;
      --color-orange-500: #a84b2f;

      /* RGB versions for opacity control */
      --color-brown-600-rgb: 94, 82, 64;
      --color-teal-500-rgb: 33, 128, 141;
      --color-slate-900-rgb: 19, 52, 59;
      --color-slate-500-rgb: 98, 108, 113;
      --color-red-500-rgb: 192, 21, 47;
      --color-red-400-rgb: 255, 84, 89;
      --color-orange-500-rgb: 168, 75, 47;
      --color-orange-400-rgb: 230, 129, 97;

      /* Background color tokens (Light Mode) */
      --color-bg-1: rgba(59, 130, 246, 0.08);
      --color-bg-2: rgba(245, 158, 11, 0.08);
      --color-bg-3: rgba(34, 197, 94, 0.08);
      --color-bg-4: rgba(239, 68, 68, 0.08);
      --color-bg-5: rgba(147, 51, 234, 0.08);
      --color-bg-6: rgba(249, 115, 22, 0.08);
      --color-bg-7: rgba(236, 72, 153, 0.08);
      --color-bg-8: rgba(6, 182, 212, 0.08);

      /* Semantic Color Tokens (Light Mode) */
      --color-background: var(--color-cream-50);
      --color-surface: var(--color-cream-100);
      --color-text: var(--color-slate-900);
      --color-text-secondary: var(--color-slate-500);
      --color-primary: var(--color-teal-500);
      --color-primary-hover: var(--color-teal-600);
      --color-primary-active: var(--color-teal-700);
      --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
      --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
      --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
      --color-border: rgba(var(--color-brown-600-rgb), 0.2);
      --color-btn-primary-text: var(--color-cream-50);
      --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
      --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
      --color-error: var(--color-red-500);
      --color-success: var(--color-teal-500);
      --color-warning: var(--color-orange-500);
      --color-info: var(--color-slate-500);
      --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
      --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);
      --color-success-rgb: 33, 128, 141;
      --color-error-rgb: 192, 21, 47;
      --color-warning-rgb: 168, 75, 47;
      --color-info-rgb: 98, 108, 113;

      /* Common style patterns */
      --focus-ring: 0 0 0 3px var(--color-focus-ring);
      --focus-outline: 2px solid var(--color-primary);
      --status-bg-opacity: 0.15;
      --status-border-opacity: 0.25;

      /* Typography */
      --font-family-base: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --font-family-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --font-size-xs: 11px;
      --font-size-sm: 12px;
      --font-size-base: 14px;
      --font-size-md: 14px;
      --font-size-lg: 16px;
      --font-size-xl: 18px;
      --font-size-2xl: 20px;
      --font-size-3xl: 24px;
      --font-size-4xl: 30px;
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 550;
      --font-weight-bold: 600;
      --line-height-tight: 1.2;
      --line-height-normal: 1.5;
      --letter-spacing-tight: -0.01em;

      /* Spacing */
      --space-0: 0;
      --space-1: 1px;
      --space-2: 2px;
      --space-4: 4px;
      --space-6: 6px;
      --space-8: 8px;
      --space-10: 10px;
      --space-12: 12px;
      --space-16: 16px;
      --space-20: 20px;
      --space-24: 24px;
      --space-32: 32px;

      /* Border Radius */
      --radius-sm: 6px;
      --radius-base: 8px;
      --radius-md: 10px;
      --radius-lg: 12px;
      --radius-full: 9999px;

      /* Shadows */
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
        0 2px 4px -1px rgba(0, 0, 0, 0.02);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
        0 4px 6px -2px rgba(0, 0, 0, 0.02);

      /* Animation */
      --duration-fast: 150ms;
      --duration-normal: 250ms;
      --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

      /* Layout */
      --container-sm: 640px;
      --container-md: 768px;
      --container-lg: 1024px;
      --container-xl: 1280px;
    }

    /* Base styles */
    html {
      font-size: var(--font-size-base);
      font-family: var(--font-family-base);
      line-height: var(--line-height-normal);
      color: var(--color-text);
      background-color: var(--color-background);
      -webkit-font-smoothing: antialiased;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
    }

    *,
    *::before,
    *::after {
      box-sizing: inherit;
    }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }
    
    /* Layout */
    .app-container {
      min-height: 100vh;
      background-color: var(--color-background);
      position: relative;
    }
    
    .view {
      padding: var(--space-32) 0;
      min-height: 100vh;
    }
    
    .container {
      width: 100%;
      margin: 0 auto;
      padding: 0 var(--space-16);
      max-width: var(--container-lg);
    }
    
    /* Landing View */
    .landing-header {
      text-align: center;
      margin-bottom: var(--space-32);
    }
    
    .main-title {
      font-size: var(--font-size-4xl);
      font-weight: var(--font-weight-bold);
      margin: 0 auto var(--space-16) auto;
    }
    
    .hero-subtitle {
      font-size: var(--font-size-xl);
      color: var(--color-text-secondary);
      max-width: 600px;
      margin: 0 auto var(--space-32) auto;
    }
    
    .landing-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--space-24);
    }
    
    .landing-card {
      text-align: center;
    }
    
    .card__body {
      padding: var(--space-24);
    }
    
    /* Form elements */
    .form-group {
      margin-bottom: var(--space-16);
    }
    
    .form-label {
      display: block;
      margin-bottom: var(--space-8);
      font-weight: var(--font-weight-medium);
      font-size: var(--font-size-sm);
    }
    
    .form-control {
      width: 100%;
      padding: var(--space-12) var(--space-16);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      background-color: var(--color-surface);
      color: var(--color-text);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-16);
    }
    
    @media (min-width: 640px) {
      .form-row {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    /* Buttons */
    .btn {
      padding: var(--space-12) var(--space-24);
      border-radius: var(--radius-base);
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      border: none;
      transition: all var(--duration-fast) ease-in-out;
    }
    
    .btn--primary {
      background-color: var(--color-primary);
      color: var(--color-white);
    }
    
    .btn--secondary {
      background-color: var(--color-secondary);
      color: var(--color-text);
    }
    
    .btn--outline {
      background-color: transparent;
      border: 1px solid var(--color-border);
      color: var(--color-text);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Config View */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-32);
      flex-wrap: wrap;
    }
    
    .game-code-display {
      display: flex;
      align-items: center;
      gap: var(--space-12);
    }
    
    .config-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-24);
    }
    
    @media (min-width: 768px) {
      .config-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    .card {
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-card-border);
      box-shadow: var(--shadow-sm);
    }
    
    .color-picker-group {
      display: flex;
      align-items: center;
      gap: var(--space-12);
    }
    
    .color-input {
      width: 48px;
      height: 48px;
      padding: 0;
      border: none;
      cursor: pointer;
      background: none;
    }
    
    .color-preview {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
    }
    
    /* Setup View */
    .setup-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-24);
    }
    
    @media (min-width: 768px) {
      .setup-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    .roster-list {
      max-height: 300px;
      overflow-y: auto;
      padding-top: var(--space-16);
    }
    
    .roster-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-12) var(--space-16);
      background-color: var(--color-bg-1);
      border-radius: var(--radius-base);
      margin-bottom: var(--space-8);
    }
    
    .roster-number {
      font-weight: var(--font-weight-bold);
      margin-right: var(--space-12);
    }
    
    .remove-player {
      background-color: var(--color-red-500);
      color: var(--color-white);
      border: none;
      padding: var(--space-4) var(--space-8);
      border-radius: var(--radius-sm);
      cursor: pointer;
    }
    
    /* Control View */
    .control-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: var(--space-24);
      border-bottom: 1px solid var(--color-border);
      margin-bottom: var(--space-24);
      flex-wrap: wrap;
    }
    
    .control-actions {
      display: flex;
      gap: var(--space-12);
    }
    
    .scoreboard {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-24);
      text-align: center;
    }
    
    @media (min-width: 768px) {
      .scoreboard {
        grid-template-columns: 1fr auto 1fr;
        gap: var(--space-32);
      }
    }
    
    .team-score {
      border-radius: var(--radius-lg);
      padding: var(--space-24);
      transition: all var(--duration-fast) ease-in-out;
    }
    
    .score-display {
      font-size: 5rem;
      font-weight: var(--font-weight-bold);
    }
    
    .score-controls {
      display: flex;
      justify-content: center;
      gap: var(--space-8);
    }
    
    .score-btn {
      padding: var(--space-8) var(--space-16);
    }
    
    .clock-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-16);
    }
    
    .clock-display {
      font-size: 3rem;
      font-weight: var(--font-weight-bold);
      font-family: var(--font-family-mono);
      background-color: var(--color-surface);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-base);
      padding: var(--space-16) var(--space-24);
    }
    
    .shot-clock-display {
      font-size: 2rem;
      font-weight: var(--font-weight-bold);
      font-family: var(--font-family-mono);
      color: var(--color-warning);
      background-color: var(--color-surface);
      border: 2px solid var(--color-warning);
      border-radius: var(--radius-base);
      padding: var(--space-8) var(--space-16);
      transition: all var(--duration-fast) ease-in-out;
    }
    
    .shot-clock-display.warning {
      animation: pulse 1s infinite alternate;
    }
    
    @keyframes pulse {
      from { transform: scale(1); }
      to { transform: scale(1.05); border-color: var(--color-red-500); }
    }
    
    .possession-controls {
      display: flex;
      gap: var(--space-8);
    }
    
    .stats-section {
      margin-top: var(--space-32);
    }
    
    .player-scoring-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--space-16);
      margin-top: var(--space-16);
    }
    
    .player-score-card {
      background-color: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-base);
      padding: var(--space-16);
      transition: all var(--duration-fast) ease-in-out;
      cursor: pointer;
    }
    
    .player-score-card:hover, .player-score-card.selected {
      border-color: var(--color-primary);
      box-shadow: var(--shadow-md);
    }
    
    .player-scoring-buttons {
      display: flex;
      gap: var(--space-8);
      margin-top: var(--space-12);
    }
    
    /* Viewer View */
    .viewer-scoreboard {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-24);
      text-align: center;
    }
    
    @media (min-width: 768px) {
      .viewer-scoreboard {
        grid-template-columns: 1fr auto 1fr;
        gap: var(--space-32);
      }
    }
    
    .viewer-score {
      font-size: 6rem;
      font-weight: var(--font-weight-bold);
    }
    
    /* Modals */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background-color: var(--color-surface);
      padding: var(--space-24);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 400px;
    }
    
    .modal-actions {
      margin-top: var(--space-16);
      display: flex;
      justify-content: flex-end;
      gap: var(--space-8);
    }
    
    /* Toasts */
    .toast-container {
      position: fixed;
      top: var(--space-24);
      right: var(--space-24);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: var(--space-8);
    }
    
    .toast {
      padding: var(--space-12) var(--space-16);
      border-radius: var(--radius-base);
      box-shadow: var(--shadow-md);
      color: var(--color-white);
      font-weight: var(--font-weight-medium);
      transform: translateX(120%);
      transition: all 0.3s ease-out;
    }
    
    .toast.success { background-color: var(--color-success); }
    .toast.info { background-color: var(--color-info); }
    .toast.warning { background-color: var(--color-warning); }
    .toast.error { background-color: var(--color-error); }
    .toast.large { max-width: 300px; }
    
  </style>
</head>
<body>
  <audio id="buzzerSound" preload="auto">
    <source src="https://r2cdn.perplexity.ai/audio/buzzer.mp3" type="audio/mpeg"/>
  </audio>

  <div class="app-container">
    <!-- Landing View - The starting page where users can choose to host or watch a game. -->
    <section id="landing-view" class="view container">
      <header class="landing-header">
        <div class="basketball-icon">üèÄ</div>
        <h1 class="main-title">Basketball Scoreboard Pro</h1>
        <p class="hero-subtitle">Create a game, run clocks, update scores, and track player stats in real time.</p>
      </header>
      <div class="landing-cards">
        <article class="card landing-card">
          <div class="card__body">
            <h3>Watch a Game</h3>
            <div class="form-group">
              <label class="form-label" for="watchCodeInput">Game Code</label>
              <input id="watchCodeInput" class="form-control" placeholder="6-digit code" maxlength="6"/>
            </div>
            <div class="section-actions">
              <button id="watchGameBtn" class="btn btn--primary" disabled>Watch Game</button>
            </div>
          </div>
        </article>
        <article class="card landing-card">
          <div class="card__body">
            <h3>Host a New Game</h3>
            <div class="form-group">
              <label class="form-label" for="hostPasswordInput">Host Password</label>
              <input id="hostPasswordInput" class="form-control" type="password" placeholder="Min 4 characters"/>
            </div>
            <div class="section-actions">
              <button id="createGameBtn" class="btn btn--primary">Create Game</button>
            </div>
          </div>
        </article>
        <article class="card landing-card">
          <div class="card__body">
            <h3>Start a Quick Game</h3>
            <p>Creates a friendly game with instant controls and no player rosters.</p>
            <div class="section-actions">
              <button id="quickGameBtn" class="btn btn--secondary">Start Quick Game</button>
            </div>
          </div>
        </article>
      </div>
    </section>

    <!-- Config View - The page for setting up game rules and team details. -->
    <section id="config-view" class="view container hidden">
      <div class="section-header">
        <div>
          <h2>Game Configuration</h2>
          <div class="game-code-display">
            <span>Code:</span>
            <strong id="configGameCode"></strong>
            <button id="copyConfigCode" class="btn btn--outline">Copy</button>
          </div>
        </div>
        <button id="backToLandingFromConfig" class="btn btn--outline">Back</button>
      </div>
      <div class="config-grid">
        <div class="card">
          <div class="card__body">
            <h4>Basics</h4>
            <div class="form-group">
              <label class="form-label" for="gameNameInput">Game Name</label>
              <input id="gameNameInput" class="form-control" placeholder="e.g., U16 Semifinal"/>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="periodDurationSelect">Period Duration (min)</label>
                <select id="periodDurationSelect" class="form-control">
                  <option value="10">10</option>
                  <option value="12" selected>12</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" for="shotClockSelect">Shot Clock (sec)</label>
                <select id="shotClockSelect" class="form-control">
                  <option value="0">Disabled</option>
                  <option value="14">14</option>
                  <option value="24" selected>24</option>
                  <option value="custom">Custom</option>
                </select>
              </div>
            </div>
            <div id="customShotClockGroup" class="form-group hidden">
              <label class="form-label" for="customShotClock">Custom Shot Clock</label>
              <input id="customShotClock" class="form-control" type="number" min="0" max="60" value="24"/>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card__body">
            <h4>Game Type</h4>
            <div class="game-type-selection">
              <label class="game-type-option">
                <input type="radio" name="gameType" value="friendly" checked/>
                <div class="game-type-card">
                  <h4>Friendly</h4>
                  <p>No rosters required</p>
                </div>
              </label>
              <label class="game-type-option">
                <input type="radio" name="gameType" value="full"/>
                <div class="game-type-card">
                  <h4>Full Stats</h4>
                  <p>Rosters & player stats</p>
                </div>
              </label>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card__body">
            <h4>Teams</h4>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="teamAName">Team A</label>
                <input id="teamAName" class="form-control" placeholder="Team A"/>
              </div>
              <div class="form-group">
                <label class="form-label" for="teamBName">Team B</label>
                <input id="teamBName" class="form-control" placeholder="Team B"/>
              </div>
            </div>
            <div class="form-row color-picker-group">
              <div class="form-group">
                <label class="form-label" for="teamAColor">Team A Color</label>
                <input id="teamAColor" class="form-control color-input" type="color" value="#FF6B35"/>
              </div>
              <div class="form-group">
                <label class="form-label" for="teamBColor">Team B Color</label>
                <input id="teamBColor" class="form-control color-input" type="color" value="#1B263B"/>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="section-actions">
        <button id="proceedToSetup" class="btn btn--primary">Continue</button>
      </div>
    </section>

    <!-- Setup View - The page for adding players to rosters (if 'Full Stats' was selected). -->
    <section id="setup-view" class="view container hidden">
      <div class="section-header">
        <div>
          <h2>Team Setup</h2>
          <div class="game-code-display">
            <span>Code:</span>
            <strong id="setupGameCode"></strong>
            <button id="copySetupCode" class="btn btn--outline">Copy</button>
          </div>
        </div>
        <div class="section-actions">
          <button id="backToConfig" class="btn btn--outline">Back</button>
          <button id="skipRosterSetup" class="btn btn--secondary">Skip Rosters</button>
          <button id="startGame" class="btn btn--primary">Start Game</button>
        </div>
      </div>
      <div class="setup-grid">
        <div class="card team-setup-card">
          <div class="card__body">
            <h3 id="teamASetupTitle">Team A</h3>
            <div class="form-row">
              <input id="teamAPlayerNumber" class="form-control" type="number" min="0" max="99" placeholder="Jersey #"/>
              <input id="teamAPlayerName" class="form-control" placeholder="Name"/>
              <button id="addTeamAPlayer" class="btn btn--secondary">Add</button>
            </div>
            <div id="teamARoster" class="roster-list"></div>
            <div class="roster-counter">Players: <span id="teamACount">0</span></div>
          </div>
        </div>
        <div class="card team-setup-card">
          <div class="card__body">
            <h3 id="teamBSetupTitle">Team B</h3>
            <div class="form-row">
              <input id="teamBPlayerNumber" class="form-control" type="number" min="0" max="99" placeholder="Jersey #"/>
              <input id="teamBPlayerName" class="form-control" placeholder="Name"/>
              <button id="addTeamBPlayer" class="btn btn--secondary">Add</button>
            </div>
            <div id="teamBRoster" class="roster-list"></div>
            <div class="roster-counter">Players: <span id="teamBCount">0</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Control View - The main control panel for scoring and managing the game. -->
    <section id="control-view" class="view container hidden">
      <div class="control-header">
        <div>
          <h2 id="controlGameName">Basketball Game</h2>
          <div class="game-code-display">
            <span>Code:</span>
            <strong id="controlGameCode"></strong>
            <button id="copyControlCode" class="btn btn--outline">Copy</button>
          </div>
        </div>
        <div class="control-actions">
          <button id="goToViewer" class="btn btn--secondary">Open Viewer</button>
          <button id="resetAllClocksBtn" class="btn btn--outline">Reset Clocks</button>
          <button id="startGameBtn" class="btn btn--primary master-start-btn resume">START GAME</button>
        </div>
      </div>

      <div class="scoreboard">
        <div class="team-score" id="teamACol">
          <h3 id="teamANameHdr">Team A</h3>
          <div class="score-display" id="teamAScore">0</div>
          <div class="score-controls">
            <button class="btn score-btn" id="teamAPlus1">+1</button>
            <button class="btn score-btn" id="teamAPlus2">+2</button>
            <button class="btn score-btn" id="teamAPlus3">+3</button>
            <button class="btn score-btn" id="teamAMinus1">-1</button>
          </div>
        </div>
        <div class="clock-section">
          <div class="period-display">Period: <span id="periodDisplay">1</span></div>
          <div class="clock-display" id="clockDisplay">12:00</div>
          <div class="master-clock-controls">
            <div class="clock-control-row">
              <button id="editClockBtn" class="btn btn--outline">Edit Game Clock</button>
              <button id="nextPeriodBtn" class="btn btn--secondary">Next Period</button>
              <button id="prevPeriodBtn" class="btn btn--secondary">Prev Period</button>
            </div>
          </div>
          <div class="shot-clock-section" id="shotClockSection">
            <div class="shot-clock-display" id="shotClockDisplay">24</div>
            <div class="shot-clock-label">Shot Clock</div>
            <div class="shot-clock-actions">
              <button id="startShotClockBtn" class="btn btn--secondary">Start Shot Clock</button>
              <button id="resetShot14Btn" class="btn btn--outline">Reset 14</button>
              <button id="resetShot24Btn" class="btn btn--outline">Reset 24</button>
              <button id="editShotClockBtn" class="btn btn--outline">Edit Shot</button>
            </div>
          </div>
          <div class="possession-controls">
            <button id="possessionTeamA" class="btn btn--secondary">Possession: Team A</button>
            <button id="possessionTeamB" class="btn btn--secondary">Possession: Team B</button>
          </div>
        </div>
        <div class="team-score" id="teamBCol">
          <h3 id="teamBNameHdr">Team B</h3>
          <div class="score-display" id="teamBScore">0</div>
          <div class="score-controls">
            <button class="btn score-btn" id="teamBPlus1">+1</button>
            <button class="btn score-btn" id="teamBPlus2">+2</button>
            <button class="btn score-btn" id="teamBPlus3">+3</button>
            <button class="btn score-btn" id="teamBMinus1">-1</button>
          </div>
        </div>
      </div>
      <!-- Stats section for 'Full Stats' games -->
      <section id="statsSection" class="stats-section hidden">
        <div class="stats-header">
          <h3>Player Scoring</h3>
          <div class="stats-controls">
            <select id="statTeamSelect" class="form-control">
              <option value="teamA">Team A</option>
              <option value="teamB">Team B</option>
            </select>
          </div>
        </div>
        <div class="player-scoring-grid" id="playerScoringGrid"></div>
      </section>
    </section>

    <!-- Viewer View - A minimal, large-display view for spectators and referees. -->
    <section id="viewer-view" class="view container hidden">
      <div class="viewer-scoreboard">
        <div class="viewer-team">
          <h2 id="viewerTeamAName">Team A</h2>
          <div class="viewer-score" id="viewerTeamAScore">0</div>
        </div>
        <div class="viewer-center">
          <div class="viewer-clock" id="viewerClock">12:00</div>
          <div class="viewer-period">Period: <span id="viewerPeriod">1</span></div>
          <div class="viewer-shot-clock" id="viewerShotClock">24</div>
        </div>
        <div class="viewer-team">
          <h2 id="viewerTeamBName">Team B</h2>
          <div class="viewer-score" id="viewerTeamBScore">0</div>
        </div>
      </div>
      <div class="viewer-info">
        <div class="game-name" id="viewerGameName">Basketball Game</div>
        <div class="possession-indicator" id="viewerPossession">Possession: Team A</div>
      </div>
    </section>
  </div>

  <!-- Shot Clock Violation Modal -->
  <div id="shotClockViolation" class="violation-alert hidden">
    <div class="violation-content">
      <div class="violation-icon">‚è±Ô∏è</div>
      <div class="violation-text">SHOT CLOCK VIOLATION</div>
    </div>
  </div>

  <!-- Edit Game Clock Modal -->
  <div id="editClockModal" class="modal hidden">
    <div class="modal-content">
      <h3>Edit Game Clock</h3>
      <div class="form-row">
        <input id="editMinutes" class="form-control" type="number" min="0" max="59"/>
        <input id="editSeconds" class="form-control" type="number" min="0" max="59"/>
      </div>
      <div class="modal-actions">
        <button id="cancelClockEdit" class="btn btn--secondary">Cancel</button>
        <button id="saveClockEdit" class="btn btn--primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Edit Shot Clock Modal -->
  <div id="editShotClockModal" class="modal hidden">
    <div class="modal-content">
      <h3>Edit Shot Clock</h3>
      <input id="editShotClockSeconds" class="form-control" type="number" min="0" max="60"/>
      <div class="modal-actions">
        <button id="cancelShotClockEdit" class="btn btn--secondary">Cancel</button>
        <button id="saveShotClockEdit" class="btn btn--primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastContainer" class="toast-container"></div>
</body>
</html>
